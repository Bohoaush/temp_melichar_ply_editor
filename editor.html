<!DOCTYPE html>
<html>
<head>
    <title>temp melichar ply editor</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            /*background-color: #121212;*/
            background-image: linear-gradient(to bottom right, #004488, #000011);
            color: #CCCCCC;
            font-family: Calibri, Ubuntu;
        }
        input {
            /*background-color: #003399;*/
            background-color: rgba(233,233,233,0.1);
            color: #EEEEEE;
            transition-duration: 0.4s;
            border: 1px solid white;
            padding: 11px;
            border-radius: 16px;
            font-family: Calibri, Ubuntu;
            font-size: 100%;
            /*font-weight: bold;*/
        }
        input:hover {
            /*background-color: #004499;*/
            background-color: rgba(233,233,233,0.8);
            color: rgba(0,33,99,.8);
        }
        input:active {
            background-color: #111155;
        }
        select {
            background-color: rgba(233,233,233,0.1);
            color: #EEEEEE;
            border: 1px solid white;
            padding: 5px;
            border-radius: 4px;
            font-family: Calibri, Ubuntu;
            font-weight: bold;
        }
        #topbar {
            display: flex;
        }
        #rowarn {
            font-weight: bold;
            color: yellow;
        }
        #userlabel {
            flex-grow: 1;
            text-align: center;
            height: 100%;
            background-color: white;
        }
        #acti-por div {
            display: inline-block;
        }
        #inspWr button{
            background-color: #0055AA;
            color: #EEEEEE;
            transition-duration: 0.2s;
            border: 1px solid white;
            padding: 5px;
            border-radius: 4px;
            font-family: Calibri, Ubuntu;
            font-weight: bold;
        }
        #inspWr button:hover {
            background-color: #004499;
        }
        #inspWr button:active {
            background-color: #111155;
        }
        #inspFltrContain button {
            background-color: lightblue;
            color: black;
        }
        .fixTableHead {
            overflow-y: auto;
            height: 800px;
        }
        .fixTableHead thead th {
            position: sticky;
            top: 0;
        }
        table {
            border-spacing: 0;
            border-collapse: collapse;
            width: 100%;
            /*border-radius: 10px;
            border: 1px solid rgba(233,233,233,0.3);*/
        }
        th,
        td {
            padding: 8px 15px;
        }
        th {
            /*background: #111155;*/
            background-color: rgba(22,22,22,0.3);
            backdrop-filter: blur(15px);
        }
        td {
            background-image: linear-gradient(to bottom, rgba(40,40,40,0.5), rgba(10,10,10,0.5));
            border: 1px solid rgba(233,233,233,0.3);
        }
        /*.even {
            background-color: #222222;
            background-image: linear-gradient(to bottom, rgba(44,88,100,0.5), rgba(0,20,55,0.5));
        }*/
        .notafiller {
            /*background-color: #222244;*/
            background-image: linear-gradient(to bottom, rgba(40,100,233,1), rgba(30,50,100,1));
        }
        .selectedAdd {
            /*color: #000088;*/
            /*background-color: #BBBB00;*/
            background-image: linear-gradient(to bottom, rgba(0,255,255,0.7), rgba(40,40,40,0.5), rgba(0,255,255,0.5));
        }
        .selectedPlyIt {
            background-image: linear-gradient(to bottom, rgba(0,255,255,0.7), rgba(40,40,40,0.5), rgba(0,255,255,0.5));
        }
        .selectedPlyIt.notafiller {
            background-image: linear-gradient(to bottom, rgba(0,255,255,0.7), rgba(40,100,233,1), rgba(0,255,255,0.5));
        }
        .dummy {
            background-image: linear-gradient(to bottom, rgba(255,0,0,0.5), rgba(200,10,10,0.5));
        }
        .selectedPlyIt.dummy {
            background-image: linear-gradient(to bottom, rgba(200,255,255,0.7), rgba(255,0,0,.7), rgba(200,255,255,0.5));
        }
        .live {
            background-image: linear-gradient(to bottom, rgba(255,170,0,0.5), rgba(200,50,10,0.5));
        }
        .selectedPlyIt.live {
            background-image: linear-gradient(to bottom, rgba(200,255,255,0.7), rgba(255,170,0,0.5), rgba(200,255,255,0.5));
        }
        #plyViWr {
            width: 60%;
        }
        #inspWr {
            width: 35%;
        }
        #inspWr table tbody td {
            word-wrap: break-word;
            max-width: 70%;
        }
        #buttonsOnRight {
            float: right;
        }
    </style>
</head>
<body>
<div id="status-view">
</div>
<div id="button-panel">
    <div id="topbar">
        <input id="save" type="button" value="SAVE">
        &nbsp
        <select id="ldfilename"></select>
        &nbsp
        <input id="load" type="button" value="LOAD">
        &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
        <input type="checkbox" id="autoScroll"> enable auto scroll (use alt + up/down to scroll manually)
        &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
        &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
        <span id="rowarn"></span>
        &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
        &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
        <div id="userlabel"></div>
    </div>
    <hr>
    <input id="insert" type="button" value="INSERT">
    <input id="add" type="button" value="ADD">
    &nbsp&nbsp&nbsp&nbsp
    <input id="ins-dummy" type="button" value="INSERT DUMMY">
    <input id="add-dummy" type="button" value="ADD DUMMY">
    &nbsp&nbsp&nbsp&nbsp
    <input id="ins-live" type="button" value="INSERT LIVE">
    <input id="add-live" type="button" value="ADD LIVE">
    &nbsp&nbsp&nbsp&nbsp
    <input id="remove" type="button" value="DELETE">
    &nbsp&nbsp&nbsp&nbsp
    <input id="mvUp" type="button" value="UP">
    <input id="mvDwn" type="button" value="DOWN">
    &nbsp&nbsp&nbsp&nbsp
    <input id="updInsp" type="button" value="UPDATE AVAILABLE CLIPS">
    <div id="buttonsOnRight">
    <a href="copy"><input id="gotoFilecopier" type="button" value="==>> GO TO FILE COPIER ==>>"></a>
    <input id="signOut" type="button" value="Sign out">
    </div>
</div>
<hr>
<div id="acti-por">
    <div class="fixTableHead" id="plyViWr">
        <table id="ply-view">
            <thead>
                <tr><th>start time</th><th>duration</th><th>path</th><th>logo</th><th>logo 4:3</th><th>disable IS</th><th>loop</th></tr>
            </thead>
            <tbody id="plyitemstbl">
                
            </tbody>
        </table>
    </div>
    <div class="fixTableHead" id="inspWr">
        <input type="checkbox" id="filterToggle" checked> enable filtering
        <input type="checkbox" id="filterSubstrToggle"> enable substring filtering
        &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
        available clips:<br><div id="inspCtgContain"></div><div id="inspFltrContain"></div>
        <table id="inspector">
            <thead>
                <tr><th>name</th><th>duration</th></tr>
            </thead>
            <tbody id="avaClipTabl">
            </tbody>
        </table>
    </div>
</div>
</body>
</html>

<script>
    var uiLdPly = {plyitems:[]};
    var availableClips;
    var availableLogos;
    var availClipCategories = [];
    var currClipCategory = "";
    var availClipFilters = [];
    var currClipFilter = "";

    var myUrl = (window.location.protocol + "//" + window.location.hostname + ":" + window.location.port);
    
    var selectedPlyItem = -1;
    var selectedAddItem = -1;
    
    var curLdPlyName;
    var unsavedChanges = false;

    var accessLevels = JSON.parse(httpGet(myUrl + "/checkaccesslevels"));

    if (accessLevels.editor == "read") {
        let savebutton = document.getElementById("save");
        savebutton.disabled = true;
        savebutton.style.backgroundColor = "gray";
        savebutton.title = "The editor is in read-only mode!";
        document.getElementById("rowarn").innerHTML = "READ-ONLY MODE!";
    }
    if (accessLevels.copier != true) {
        let gotocopbutton = document.getElementById("gotoFilecopier");
        gotocopbutton.disabled = true;
        gotocopbutton.style.backgroundColor = "gray";
        gotocopbutton.title = "The file copier is disabled!";
    }

    var userlabelinfo = JSON.parse(httpGet(myUrl + "/getuserlabel"));
    const userlabel = document.getElementById("userlabel");
    userlabel.innerHTML = userlabelinfo.label;
    userlabel.style.color = userlabelinfo.color;
    userlabel.style.backgroundColor = userlabelinfo.bgcolor;

    function confirmClose() {
        if (unsavedChanges) {
            console.log("unsaved changes");
            return confirm("You have unsaved changes! Proceed?");
        } else {
            console.log("confirming close");
            return true;
        }
    }

    window.addEventListener("beforeunload", (event) => {
        if (unsavedChanges) {
            event.returnValue = "You have unsaved changes! Proceed?";
        }
    });

    $("#signOut").click(function() {
        if (confirmClose()) {
            httpGet(myUrl + "/logout");

            const cookies = document.cookie.split(";");

            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i];
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
            location.reload();
        }
    });

    function updateStatus(type, msg) {
        let statusView = document.getElementById("status-view");
        let currentTime = "";
        if (msg != "") {
            currentTime = (((new Date()).toString()).split(" GMT")[0] + ": ");
        }
        if (type == "ok") {
            statusView.style.color = "green";
            statusView.style.backgroundColor = "#DDFFDD";
        } else if (type == "warn") {
            statusView.style.color = "orange";
            statusView.style.backgroundColor = "#FFFFEE";
        } else {
            statusView.style.color = "red";
            statusView.style.backgroundColor = "#FFDDDD";
        }
        statusView.innerHTML = (currentTime + msg);
    }
    
    $("#updInsp").click(function() {
        updateInspector();
    });
    
    updateInspector();
    
    function updateInspector() {
        availableClips = JSON.parse(httpGet(myUrl + "/clips"));
        let inspItOdd = false;
        if (availableClips.status == "ok") {
            console.log(availableClips.status);
            var clipToWriteToInsp = "";
            var wayBack = currClipCategory.split("/");
            wayBack = currClipCategory.replace((wayBack[wayBack.length - 2] + "/"), "");
            var clipCatToWrite = "<button class=\"ctgbtn\" value=\"\">root</button><button class=\"ctgbtn\" value=\"" + wayBack + "\">back</button>";
            availClipCategories = [];
            availableLogos = [];
            availClipFilters = [];
            let prevClipBegi = "";
            var clipFilterToWrite = "<button class=\"fltrbtn\" value=\"\">clear</button>";
            for (var i = 0; i < availableClips.data.length; i++) {
                availableClips.data[i].name = (availableClips.data[i].name).replace("aaavyplne", "_0vyplne");
                if (document.getElementById("filterToggle").checked) {
                    if ((availableClips.data[i].name).match("\^" + currClipCategory + "\.*" + "/")) {
                        let newcatg = (((availableClips.data[i].name.replace(currClipCategory, "")).split('/'))[0] + "/");
                        for (clipcategory of availClipCategories) {
                            if (newcatg == clipcategory) {
                                newcatg = null;
                                break;
                            }
                        }
                        if (newcatg != null){
                            availClipCategories.push(newcatg);
                            clipCatToWrite += ("<button class=\"ctgbtn\" value=\"" + (currClipCategory + newcatg) + "\">" + newcatg + "</button>");
                        }
                    }
                    if (document.getElementById("filterSubstrToggle").checked && availableClips.data[i].name.match("\^" + currClipCategory)) {
                        let currClipBegi = availableClips.data[i].name.match(/\/(?:.(?!\/))+$/);
                        if (currClipBegi == null) {
                            currClipBegi = availableClips.data[i].name;
                        } else {
                            currClipBegi = currClipBegi[0];
                        }
                        currClipBegi = currClipBegi.slice(0,6);
                        if (currClipBegi.match(prevClipBegi)) {
                            if (availClipFilters.indexOf(currClipBegi) == -1) {
                                availClipFilters.push(currClipBegi);
                                clipFilterToWrite += ("<button class=\"fltrbtn\" value=\"" + (currClipBegi) + "\">" + currClipBegi + "</button>")
                            }
                        }
                        prevClipBegi = currClipBegi;
                    } else if (!document.getElementById("filterSubstrToggle").checked){
                        // Not the best way
                        clipFilterToWrite = "";
                    }
                } else {
                    // This is verry ineffective way of doing this, but simplest for now
                    clipCatToWrite = "";
                    clipFilterToWrite = "";
                }
                if ((availableClips.data[i].name).match("\^" + currClipCategory) && availableClips.data[i].name.match(currClipFilter)) {
                    clipToWriteToInsp += "<tr class=\"avClipTblItem";
                    if (inspItOdd == false) {
                        clipToWriteToInsp += " even";
                    }
                    clipToWriteToInsp += ("\" id=\"acl" + i + "\"><td>" + availableClips.data[i].name + "</td><td>" + availableClips.data[i].duration + "</td></tr>");
                    inspItOdd = !inspItOdd;
                }
                if (availableClips.data[i].name.match(/\.png$/) || availableClips.data[i].name.match(/\.bmp$/) || availableClips.data[i].name.match(/\.tga$/)) {
                    availableLogos.push(availableClips.data[i].name);
                }
            }
            selectedAddItem = -1;
            document.getElementById("avaClipTabl").innerHTML = clipToWriteToInsp;
            document.getElementById("inspCtgContain").innerHTML = clipCatToWrite;
            document.getElementById("inspFltrContain").innerHTML = clipFilterToWrite;
            updateStatus("ok", "");
            $(".avClipTblItem").click(function(){
                conInsp = true;
                if (selectedAddItem != -1) {
                    document.getElementById(selectedAddItem).classList.remove("selectedAdd");
                }
                selectedAddItem = this.id;
                document.getElementById(selectedAddItem).classList.add("selectedAdd");
            });
            $(".ctgbtn").click(function(){
                currClipCategory = this.value;
                updateInspector();
            });
            $(".fltrbtn").click(function() {
                currClipFilter = this.value;
                console.log(this.value);
                updateInspector();
            });
        } else if (availableClips.status == "err") {
            updateStatus("err", "Unable to list available media! Is media-scanner running?");
        }
    }

    $("#filterToggle").click(function() {
        currClipCategory = "";
        currClipFilter = "";
        updateInspector();
        if (this.checked == false) {
            document.getElementById("filterSubstrToggle").checked = false;
            document.getElementById("filterSubstrToggle").disabled = true;
        } else {
            document.getElementById("filterSubstrToggle").disabled = false;
        }
    });

    $("#filterSubstrToggle").click(function() {
        currClipFilter = "";
        updateInspector();
    });
    
    function drawPlaylist() {
        var plyToDraw = "";
        for (let i = 0; i < uiLdPly.plyitems.length; i++) {
            plyToDraw += "<tr class=\"plyitem";
            
            if (i%2 == 0) {
                plyToDraw += " even";
            }
            
            var startTimeUTCms = new Date(Math.floor(uiLdPly.plyitems[i].startTime));
            var startTimeString = startTimeUTCms.toLocaleString('en-GB', {timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone});
            startTimeString = startTimeString.replace(/..\/..\/...., /, "");
            
            var plitDurHour = Math.trunc(uiLdPly.plyitems[i].duration/3600);
            if (plitDurHour < 10) {plitDurHour = "0" + plitDurHour;}
            var plitDurMinu = Math.trunc((uiLdPly.plyitems[i].duration-(plitDurHour*3600))/60);
            if (plitDurMinu < 10) {plitDurMinu = "0" + plitDurMinu;}
            var plitDurSeco = Math.floor(uiLdPly.plyitems[i].duration-(plitDurHour*3600)-(plitDurMinu*60));
            if (plitDurSeco < 10) {plitDurSeco = "0" + plitDurSeco;}
            var plitDurDisp = plitDurHour + ":" + plitDurMinu + ":" + plitDurSeco;
            
            var dummyOrNot = " dummy";
            if (uiLdPly.plyitems[i].type == "stream") {
                dummyOrNot = " live";
            } else {
                for (nomInsp of availableClips.data) {
                    if (uiLdPly.plyitems[i].path == nomInsp.name) {
                        dummyOrNot = "";
                        break;
                    }
                }
            }

            let fillerOrNot = "";
            if (!((uiLdPly.plyitems[i].path).match("0vyplne/"))) {
                fillerOrNot = " notafiller";
            }

            let logoshiftins = "";
            if (uiLdPly.plyitems[i].logoshift) {
                logoshiftins = "checked";
            }

            let disableistrins = "";
            if (uiLdPly.plyitems[i].disableistr) {
                disableistrins = "checked";
            }

            let loopins = "";
            if (uiLdPly.plyitems[i].loop) {
                loopins = "checked";
            }
            
            plyToDraw += (dummyOrNot + fillerOrNot + "\" id=\"" + i + "\"><td>" + startTimeString + "</td><td>" + plitDurDisp + "</td><td>" + uiLdPly.plyitems[i].path + "</td><td><select class=\"logosel\" id=\"logo" + i + "\"><option value=\"" + uiLdPly.plyitems[i].logo + "\">" + uiLdPly.plyitems[i].logo + "</option></select></td><td><input type=\"checkbox\" class=\"logo43shift\" id=\"lo43go" + i + "\" " +  logoshiftins + "></td><td><input type=\"checkbox\" class=\"disableistr\" id=\"disableistream" + i + "\" " + disableistrins + "></td><td><input type=\"checkbox\" class=\"loopchkbox\" id=\"loop" + i + "\" " + loopins +"></td></tr>");
        }
        document.getElementById("plyitemstbl").innerHTML = plyToDraw;
        if (selectedPlyItem != -1) {
            document.getElementById(selectedPlyItem).classList.add("selectedPlyIt");
        }
        $(".plyitem").click(function(){
            conInsp = false;
            if (selectedPlyItem != -1) {
                document.getElementById(selectedPlyItem).classList.remove("selectedPlyIt");
            }
            selectedPlyItem = this.id;
            document.getElementById(selectedPlyItem).classList.add("selectedPlyIt");
        });
        $(".logosel").focus(function() {
            var choselogo = "<option class=\"logoopt\" value=\"default\">default</option>";
            for (avalogo of availableLogos) {
                avalogo = avalogo.replace("loga_plus/", "");
                choselogo += "<option class=\"logoopt\" value=\"" + avalogo + "\">" + avalogo + "</option>"
            }
            this.innerHTML = choselogo;
            var idtochangelogo = this.id.replace("logo", "");
            $(".logoopt").click(function() {
                uiLdPly.plyitems[idtochangelogo].logo = this.value;
                console.log(this.value);
            });
        });
        $(".logo43shift").click(function() {
            let idtoshiftlogo = this.id.replace("lo43go", "");
            uiLdPly.plyitems[idtoshiftlogo].logoshift = this.checked;
        });
        $(".disableistr").click(function() {
            let idtotoggleistr = this.id.replace("disableistream", "");
            uiLdPly.plyitems[idtotoggleistr].disableistr = this.checked;
        });
        $(".loopchkbox").click(function() {
            let idtotoggleloop = this.id.replace("loop", "");
            uiLdPly.plyitems[idtotoggleloop].loop = this.checked;
        });
        
    }
    
    $("#insert").click(function() {
        insSelToPly();
    });
    
    function insSelToPly() {
        if (selectedPlyItem != -1) {
            var itemToAdd = {};
            itemToAdd.aclid = selectedAddItem.replace("acl", "");
            itemToAdd.id = selectedPlyItem;
            itemToAdd.type = "clip";
            itemToAdd.path = availableClips.data[itemToAdd.aclid].name;
            itemToAdd.duration = availableClips.data[itemToAdd.aclid].duration;
            uiLdPly.plyitems.splice(selectedPlyItem, 0, itemToAdd);
            if (selectedPlyItem > 0) {
                uiLdPly.plyitems[itemToAdd.id].id = itemToAdd.id;
                uiLdPly.plyitems[itemToAdd.id].startTime = (uiLdPly.plyitems[itemToAdd.id-1].startTime + (uiLdPly.plyitems[itemToAdd.id-1].duration*1000));
            } else {
                uiLdPly.plyitems[itemToAdd.id].startTime = new Date(Date.now());
                uiLdPly.plyitems[itemToAdd.id].startTime = uiLdPly.plyitems[itemToAdd.id].startTime.setHours(6, 0, 0);
            }
            for (let i = (itemToAdd.id - -1); i < uiLdPly.plyitems.length; i++) {
                console.log("test");
                uiLdPly.plyitems[i].id = i;
                uiLdPly.plyitems[i].startTime = (uiLdPly.plyitems[i-1].startTime + (uiLdPly.plyitems[i-1].duration*1000));
            }
            drawPlaylist();
            unsavedChanges = true;
            if (accessLevels.editor == "read") {
                window.alert("The editor is in READ-ONLY MODE! \nYou will not be able to save the playlist.");
            }
        } else {
            addSelToPly();
        }
    }
    
    $("#add").click(function() {
        addSelToPly();
    });
    
    function addSelToPly() {
        var itemToAdd = {};
        itemToAdd.aclid = selectedAddItem.replace("acl", "");
        itemToAdd.id = uiLdPly.plyitems.length;
        itemToAdd.type = "clip";
        itemToAdd.path = availableClips.data[itemToAdd.aclid].name;
        itemToAdd.duration = availableClips.data[itemToAdd.aclid].duration;
        uiLdPly.plyitems.push(itemToAdd);
        if (itemToAdd.id > 0) {
            itemToAdd.startTime = (uiLdPly.plyitems[itemToAdd.id-1].startTime + (uiLdPly.plyitems[itemToAdd.id-1].duration*1000));
        } else {
            itemToAdd.startTime = new Date(Date.now());
            console.log(itemToAdd.startTime);
            itemToAdd.startTime = itemToAdd.startTime.setHours(6, 0, 0);
        }
        drawPlaylist();
        unsavedChanges = true;
        if (accessLevels.editor == "read") {
            window.alert("The editor is in READ-ONLY MODE! \nYou will not be able to save the playlist.");
        }
    }
    
    $("#save").click(function() {
        savePly();
    });
    // TODO Inform user that saving is not possible if access level is read
    function savePly() {
        if (accessLevels.editor == "full") {
            let savefilename = window.prompt("Playlist name:", curLdPlyName || "playlist_yyyymmdd.ply");
            if (savefilename != null && savefilename != "") {
                if (!savefilename.match(/\.ply$/)) {
                    savefilename = savefilename + ".ply";
                }
                var sendPlyObj = {};
                sendPlyObj.ply = uiLdPly;
                sendPlyObj.name = savefilename;
                let saveStatus = JSON.parse(httpPost(myUrl + "/save", JSON.stringify(sendPlyObj)));
                curLdPlyName = savefilename;
                if (saveStatus.status == "ok") {
                    updateStatus("ok", "Playlist saved successfully");
                    unsavedChanges = false;
                } else {
                    updateStatus("err", "Failed to save playlist!");
                }
            } else {
                window.alert("You need to specify the filename!");
            }
        } else {
            window.alert("The editor is in READ-ONLY MODE! \nSaving is disabled.");
        }
    }
    
    $("#ldfilename").focus(function() {
        var avaPlys = JSON.parse(httpGet(myUrl + "/plys"));
        setTimeout(function(){
            console.log(avaPlys);
        }, 2000);
        var avaPlyList = "";
        for (avaPly of avaPlys) {
            avaPlyList += "<option value=\"" + avaPly + "\">" + avaPly + "</input>\n"
        }
        document.getElementById("ldfilename").innerHTML = avaPlyList;
    });
    
    $("#load").click(function() {
        loadPly();
    });
    
    function loadPly() {
        if (confirmClose()) {
            let plyToLoadList = document.getElementById("ldfilename");
            if (plyToLoadList.value != "" && plyToLoadList.value != null && plyToLoadList.value != undefined) {
                console.log(plyToLoadList.value);
                uiLdPly.plyitems = JSON.parse(httpPost((myUrl + "/open"), plyToLoadList.value));
                uiLdPly.plyitems[0].id = 0;
                uiLdPly.plyitems[0].startTime = new Date(Date.now());
                uiLdPly.plyitems[0].startTime = uiLdPly.plyitems[0].startTime.setHours(6, 0, 0);
                for (let i = 1; i < uiLdPly.plyitems.length; i++) {
                    uiLdPly.plyitems[i].id = i;
                    uiLdPly.plyitems[i].startTime = (uiLdPly.plyitems[i-1].startTime + (uiLdPly.plyitems[i-1].duration*1000));
                }
                if (selectedPlyItem >= uiLdPly.plyitems.length) {
                    selectedPlyItem = (uiLdPly.plyitems.length - 1);
                }
                drawPlaylist();
                curLdPlyName = plyToLoadList.value;
                unsavedChanges = false;
            } else {
                alert("You need to specify filename to load!");
            }
        }
    }
    
    $("#ins-dummy").click(function() {
        insertDummy();
    });
    
    function insertDummy() {
        if (selectedPlyItem != -1) {
            let dummydur = window.prompt("Dummy duration in seconds: ");
            let dummyname = window.prompt("Dummy clip name", "DUMMY_CLIP");
            if (dummydur && dummyname) {
                var itemToAdd = {};
                itemToAdd.id = selectedPlyItem;
                itemToAdd.type = "clip";
                itemToAdd.path = dummyname;
                itemToAdd.duration = dummydur;
                uiLdPly.plyitems.splice(selectedPlyItem, 0, itemToAdd);
                if (selectedPlyItem > 0) {
                    uiLdPly.plyitems[itemToAdd.id].id = itemToAdd.id;
                    uiLdPly.plyitems[itemToAdd.id].startTime = (uiLdPly.plyitems[itemToAdd.id-1].startTime + (uiLdPly.plyitems[itemToAdd.id-1].duration*1000));
                } else {
                    uiLdPly.plyitems[itemToAdd.id].startTime = new Date(Date.now());
                    uiLdPly.plyitems[itemToAdd.id].startTime = uiLdPly.plyitems[itemToAdd.id].startTime.setHours(6, 0, 0);
                }
                for (let i = (itemToAdd.id - -1); i < uiLdPly.plyitems.length; i++) {
                    console.log("test");
                    uiLdPly.plyitems[i].id = i;
                    uiLdPly.plyitems[i].startTime = (uiLdPly.plyitems[i-1].startTime + (uiLdPly.plyitems[i-1].duration*1000));
                }
                drawPlaylist();
                unsavedChanges = true;
                if (accessLevels.editor == "read") {
                    window.alert("The editor is in READ-ONLY MODE! \nYou will not be able to save the playlist.");
                }
            }
        } else {
            addDummyToPly();
        }
    }
    
    $("#add-dummy").click(function() {
        addDummyToPly();
    });
    
    function addDummyToPly() {
        let dummydur = window.prompt("Dummy duration in seconds: ");
        let dummyname = window.prompt("Dummy clip name", "DUMMY_CLIP");
        if (dummydur && dummyname) {
            var itemToAdd = {};
            itemToAdd.id = uiLdPly.plyitems.length;
            itemToAdd.type = "clip";
            itemToAdd.path = dummyname;
            itemToAdd.duration = dummydur;
            if (itemToAdd.id > 0) {
                itemToAdd.startTime = (uiLdPly.plyitems[itemToAdd.id-1].startTime + (uiLdPly.plyitems[itemToAdd.id-1].duration*1000));
            } else {
                itemToAdd.startTime = new Date(Date.now());
                itemToAdd.startTime = itemToAdd.startTime.setHours(6, 0, 0);
            }
            uiLdPly.plyitems.push(itemToAdd);
            drawPlaylist();
            unsavedChanges = true;
            if (accessLevels.editor == "read") {
                window.alert("The editor is in READ-ONLY MODE! \nYou will not be able to save the playlist.");
            }
        }
    }

    $("#ins-live").click(function() {
        insertLive();
    });

    function insertLive() {
        if (selectedPlyItem != -1) {
            let livepath = window.prompt("Live path (usualy DECKLINK 1)", "DECKLINK 1");
            let livedur = window.prompt("Live duration in seconds: ");
            if (livepath && livedur) {
                var itemToAdd = {};
                itemToAdd.id = selectedPlyItem;
                itemToAdd.type = "stream";
                itemToAdd.path = livepath;
                itemToAdd.duration = livedur;
                uiLdPly.plyitems.splice(selectedPlyItem, 0, itemToAdd);
                if (selectedPlyItem > 0) {
                    uiLdPly.plyitems[itemToAdd.id].id = itemToAdd.id;
                    uiLdPly.plyitems[itemToAdd.id].startTime = (uiLdPly.plyitems[itemToAdd.id-1].startTime + (uiLdPly.plyitems[itemToAdd.id-1].duration*1000));
                } else {
                    uiLdPly.plyitems[itemToAdd.id].startTime = new Date(Date.now());
                    uiLdPly.plyitems[itemToAdd.id].startTime = uiLdPly.plyitems[itemToAdd.id].startTime.setHours(6, 0, 0);
                }
                for (let i = (itemToAdd.id - -1); i < uiLdPly.plyitems.length; i++) {
                    console.log("test");
                    uiLdPly.plyitems[i].id = i;
                    uiLdPly.plyitems[i].startTime = (uiLdPly.plyitems[i-1].startTime + (uiLdPly.plyitems[i-1].duration*1000));
                }
                drawPlaylist();
                unsavedChanges = true;
                if (accessLevels.editor == "read") {
                    window.alert("The editor is in READ-ONLY MODE! \nYou will not be able to save the playlist.");
                }
            }
        } else {
            addLiveToPly();
        }
    }

    $("#add-live").click(function() {
        addLiveToPly();
    });

    function addLiveToPly() {
        let livepath = window.prompt("Live path (usualy DECKLINK 1)", "DECKLINK 1");
        let livedur = window.prompt("Live duration in seconds: ");
        if (livepath && livedur) {
            var itemToAdd = {};
            itemToAdd.id = uiLdPly.plyitems.length;
            itemToAdd.type = "stream";
            itemToAdd.path = livepath;
            itemToAdd.duration = livedur;
            if (itemToAdd.id > 0) {
                itemToAdd.startTime = (uiLdPly.plyitems[itemToAdd.id-1].startTime + (uiLdPly.plyitems[itemToAdd.id-1].duration*1000));
            } else {
                itemToAdd.startTime = new Date(Date.now());
                itemToAdd.startTime = itemToAdd.startTime.setHours(6, 0, 0);
            }
            uiLdPly.plyitems.push(itemToAdd);
            drawPlaylist();
            unsavedChanges = true;
            if (accessLevels.editor == "read") {
                window.alert("The editor is in READ-ONLY MODE! \nYou will not be able to save the playlist.");
            }
        }
    }
    
    $("#remove").click(function() {
        deleteItemFromPly();
    });
    
    function deleteItemFromPly() {
        if (selectedPlyItem != -1) {
            delete uiLdPly.plyitems[selectedPlyItem];
            if (selectedPlyItem == (uiLdPly.plyitems.length - 1) && selectedPlyItem > 0) {
                selectedPlyItem -= 1;
                document.getElementById(selectedPlyItem).classList.add("selectedPlyIt");
            }
            uiLdPly.plyitems = uiLdPly.plyitems.filter(aplit => aplit !== null);
            for (let i = selectedPlyItem; i < uiLdPly.plyitems.length; i++) {
                uiLdPly.plyitems[i].id = i;
                if (i > 0) {
                    uiLdPly.plyitems[i].startTime = (uiLdPly.plyitems[i-1].startTime + (uiLdPly.plyitems[i-1].duration*1000));
                } else if (i == 0) {
                    uiLdPly.plyitems[i].startTime = new Date(Date.now());
                    uiLdPly.plyitems[i].startTime = uiLdPly.plyitems[i].startTime.setHours(6, 0, 0);
                }
            }
            drawPlaylist();
            unsavedChanges = true;
            if (accessLevels.editor == "read") {
                window.alert("The editor is in READ-ONLY MODE! \nYou will not be able to save the playlist.");
            }
        } else {
            window.alert("No item selected for deletion");
        }
    }
    
    $("#mvUp").click(function() {
        mvItem(-1);
    });
    $("#mvDwn").click(function() {
        mvItem(1);
    });
    
    function mvItem(direction) {
        let templitem = uiLdPly.plyitems[selectedPlyItem]
        if (uiLdPly.plyitems[selectedPlyItem - -direction]) {
            uiLdPly.plyitems[selectedPlyItem] = uiLdPly.plyitems[selectedPlyItem - -direction];
            selectedPlyItem = selectedPlyItem - -direction;
            uiLdPly.plyitems[selectedPlyItem] = templitem;
            let recountFrom = 0;
            if (selectedPlyItem > 0) recountFrom = selectedPlyItem - 1;
            for (let i = recountFrom; i < uiLdPly.plyitems.length; i++) {
                uiLdPly.plyitems[i].id = i;
                if (i > 0) {
                    uiLdPly.plyitems[i].startTime = (uiLdPly.plyitems[i-1].startTime + (uiLdPly.plyitems[i-1].duration*1000));
                } else if (i == 0) {
                    uiLdPly.plyitems[i].startTime = new Date(Date.now());
                    uiLdPly.plyitems[i].startTime = uiLdPly.plyitems[i].startTime.setHours(6, 0, 0);
                }
            }
            drawPlaylist();
            unsavedChanges = true;
            if (accessLevels.editor == "read") {
                window.alert("The editor is in READ-ONLY MODE! \nYou will not be able to save the playlist.");
            }
        }
    } //TODO finish
    
    var conInsp = false;
    
    document.addEventListener('keydown', function(event) {
        switch(event.keyCode) {
            //insert key
            case 45:
                conInsp = true;
                break;
                
            //up arrow
            case 38:
                event.preventDefault();
                if (event.ctrlKey) {
                    mvItem(-1);
                } else if (event.altKey) {
                    var whatWillScroll;
                    if (!conInsp) {
                        whatWillScroll = document.getElementById("plyViWr");
                    } else {
                        whatWillScroll = document.getElementById("inspWr");
                    }
                    whatWillScroll.scrollTo({top: whatWillScroll.scrollTop - 200, behavior: "smooth"});
                } else if (!conInsp && selectedPlyItem > 0) {
                    document.getElementById(selectedPlyItem).classList.remove("selectedPlyIt");
                    selectedPlyItem -= 1;
                    document.getElementById(selectedPlyItem).classList.add("selectedPlyIt");
                    if (document.getElementById("autoScroll").checked) {
                        document.getElementById(selectedPlyItem).scrollIntoView({behavior: "smooth", block: "end"});
                    }
                } else if (selectedAddItem.replace("acl", "") > 0) {
                    document.getElementById(selectedAddItem).classList.remove("selectedAdd");
                    selectedAddItem = selectedAddItem.replace("acl", "");
                    selectedAddItem -= 1;
                    selectedAddItem = ("acl" + selectedAddItem);
                    document.getElementById(selectedAddItem).classList.add("selectedAdd");
                    if (document.getElementById("autoScroll").checked) {
                        document.getElementById(selectedAddItem).scrollIntoView({behavior: "smooth", block: "end"});
                    }
                }
                break;
                
            //down arrow
            case 40:
                event.preventDefault();
                if (event.ctrlKey) {
                    mvItem(1);
                } else if (event.altKey) {
                    var whatWillScroll;
                    if (!conInsp) {
                        whatWillScroll = document.getElementById("plyViWr");
                    } else {
                        whatWillScroll = document.getElementById("inspWr");
                    }
                    whatWillScroll.scrollTo({top: whatWillScroll.scrollTop + 200, behavior: "smooth"});
                } else if (!conInsp && selectedPlyItem < uiLdPly.plyitems.length - 1) {
                    document.getElementById(selectedPlyItem).classList.remove("selectedPlyIt");
                    selectedPlyItem -= -1;
                    document.getElementById(selectedPlyItem).classList.add("selectedPlyIt");
                    if (document.getElementById("autoScroll").checked) {
                        document.getElementById(selectedPlyItem).scrollIntoView({behavior: "smooth", block: "end"});
                    }
                } else if (selectedAddItem.replace("acl", "") < availableClips.data.length - 1) {
                    document.getElementById(selectedAddItem).classList.remove("selectedAdd");
                    selectedAddItem = selectedAddItem.replace("acl", "");
                    selectedAddItem -= -1;
                    selectedAddItem = ("acl" + selectedAddItem);
                    document.getElementById(selectedAddItem).classList.add("selectedAdd");
                    if (document.getElementById("autoScroll").checked) {
                        document.getElementById(selectedAddItem).scrollIntoView({behavior: "smooth", block: "end"});
                    }
                }
                break;
                
            //enter
            case 13:
                if (conInsp) {
                    if (event.ctrlKey) {
                        addSelToPly();
                        conInsp = false;
                    } else {
                        insSelToPly();
                        conInsp = false;
                    }
                }
                break;
                
            //delete
            case 46:
                deleteItemFromPly();
                break;
            
            //escape
            case 27:
                conInsp = false;
                break;
                
            //ctrl + s
            case 83:
                if (event.ctrlKey) {
                    savePly();
                    event.preventDefault();
                }
                break;
            case 76:
                document.getElementById("autoScroll").checked = !document.getElementById("autoScroll").checked;
        }
    }, true);
    
    function httpGet(url) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", url, false );
        xmlHttp.withCredentials = true;
        xmlHttp.send( null );
        return xmlHttp.responseText;
    }
    
    function httpPost(url, data) {
        try {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("POST", url, false);
            xmlHttp.withCredentials = true;
            xmlHttp.send(data);
            return xmlHttp.responseText;
        } catch {
            updateStatus("err", "Communication ERROR! Last action isn't on the back-end");
        }
    }
</script>
