<!DOCTYPE html>
<html>
<head>
    <title>temp melichar ply editor</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #CCCCCC;
        }
        #acti-por div {
            display: inline-block;
        }
        
        .fixTableHead {
            overflow-y: auto;
            height: 800px;
        }
        .fixTableHead thead th {
            position: sticky;
            top: 0;
        }
        table {
            border-collapse: collapse;        
            width: 100%;
        }
        th,
        td {
            padding: 8px 15px;
            border: 2px solid #555577;
        }
        th {
            background: #111155;
        }
        .selectedAdd {
            color: #BBBBFF;
            background-color: #222222;
        }
    </style>
</head>
<body>
<div id="button-panel">
    <input id="save" type="button" value="SAVE">
    <input id="load" type="button" value="LOAD">
    <hr>
    <input id="insert" type="button" value="INSERT">
    <input id="ins-dummy" type="button" value="INSERT DUMMY">
    <input id="add" type="button" value="ADD">
    <input id="remove" type="button" value="DELETE">
</div>
<hr>
<div id="acti-por">
    <div class="fixTableHead">
        playlist
        <table id="ply-view">
            <thead>
                <tr><th>start time</th><th>duration</th><th>path</th></tr>
            </thead>
            <tbody id="plyitemstbl">
                
            </tbody>
        </table>
    </div>
    <div class="fixTableHead">
        inspector:
        <table id="inspector">
            <thead>
                <tr><th>name</th><th>duration</th></tr>
            </thead>
            <tbody id="avaClipTabl">
            </tbody>
        </table>
    </div>
</div>
</body>
</html>

<script>
    var uiLdPly = {plyitems:[]};
    var availableClips;

    var myUrl = (window.location.protocol + "//" + window.location.hostname + ":" + window.location.port);
    
    var selectedPlyItem = -1;
    var selectedAddItem = -1;
    
    function updateInspector() {
        availableClips = JSON.parse(httpGet(myUrl + "/clips"));
        if (availableClips.status = "ok") {
            var clipToWriteToInsp = "";
            for (var i = 0; i < availableClips.data.length; i++) {
                clipToWriteToInsp += ("<tr class=\"avClipTblItem\" id=\"acl" + i + "\"><td>" + availableClips.data[i].name + "</td><td>" + availableClips.data[i].duration + "</td></tr>");
            }
            document.getElementById("avaClipTabl").innerHTML = clipToWriteToInsp;
            $(".avClipTblItem").click(function(){
                if (selectedAddItem != -1) {
                    document.getElementById(selectedAddItem).classList.remove("selectedAdd");
                }
                selectedAddItem = this.id;
                document.getElementById(selectedAddItem).classList.add("selectedAdd");
            });
        } else if (availableClips.status == "err") {
            //TODO
        }
    }
    
    function drawPlaylist() {
        var plyToDraw = "";
        for (let i = 0; i < uiLdPly.plyitems.length; i++) {
            plyToDraw += "<tr class=\"plyitem";
            
            if (i%2 == 0) {
                plyToDraw += " even";
            }
            
            var startTimeUTCms = new Date(Math.floor(uiLdPly.plyitems[i].startTime));
            var startTimeString = startTimeUTCms.toLocaleString('en-GB', {timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone});
            
            var plitDurHour = Math.trunc(uiLdPly.plyitems[i].duration/3600);
            if (plitDurHour < 10) {plitDurHour = "0" + plitDurHour;}
            var plitDurMinu = Math.trunc((uiLdPly.plyitems[i].duration-(plitDurHour*60))/60);
            if (plitDurMinu < 10) {plitDurMinu = "0" + plitDurMinu;}
            var plitDurSeco = Math.floor(uiLdPly.plyitems[i].duration-(plitDurHour*3600)-(plitDurMinu*60));
            if (plitDurSeco < 10) {plitDurSeco = "0" + plitDurSeco;}
            var plitDurDisp = plitDurHour + ":" + plitDurMinu + ":" + plitDurSeco;
            
            
            plyToDraw += ("\" id=\"" + i + "\"><td>" + startTimeString + "</td><td>" + plitDurDisp + "</td><td>" + uiLdPly.plyitems[i].path + "</td></tr>");
        }
        document.getElementById("plyitemstbl").innerHTML = plyToDraw;
    }
    
    $("#insert").click(function() {
        insSelToPly();
    });
    
    function insSelToPly() {
        if (selectedPlyItem != -1) {
            var itemToAdd = {};
            itemToAdd.aclid = selectedAddItem.replace("acl", "");
            itemToAdd.id = selectedPlyItem.id;
            itemToAdd.path = availableClips.data[itemToAdd.aclid].name;
            itemToAdd.duration = availableClips.data[itemToAdd.aclid].duration;
            uiLdPly.plyitems.splice(selectedPlyItem, 0, itemToAdd);
            for (let i = itemToAdd.id; i < uiLdPly.plyitems.length; i++) {
                uiLdPly.plyitems[i].id = i;
                uiLdPly.plyitems[i].startTime = (uiLdPly.plyitems[i-1].startTime + (uiLdPly.plyitems[i-1].duration*1000));
            }
            drawPlaylist();
        } else {
            addSelToPly();
        }
    }
    
    $("#add").click(function() {
        addSelToPly();
    });
    
    function addSelToPly() {
        var itemToAdd = {};
        itemToAdd.aclid = selectedAddItem.replace("acl", "");
        itemToAdd.id = uiLdPly.plyitems.length;
        itemToAdd.path = availableClips.data[itemToAdd.aclid].name;
        itemToAdd.duration = availableClips.data[itemToAdd.aclid].duration;
        uiLdPly.plyitems.push(itemToAdd);
        if (itemToAdd.id > 0) {
            itemToAdd.startTime = (uiLdPly.plyitems[itemToAdd.id-1].startTime + (uiLdPly.plyitems[itemToAdd.id-1].duration*1000));
        } else {
            itemToAdd.startTime = new Date(Date.now());
            console.log(itemToAdd.startTime);
            itemToAdd.startTime = itemToAdd.startTime.setHours(6, 0, 0);
        }
        drawPlaylist();
    }
    
    function httpGet(url) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", url, false );
        xmlHttp.send( null );
        return xmlHttp.responseText;
    }
    
    function httpPost(url, data) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("POST", url, false);
        xmlHttp.send(data);
        return xmlHttp.responseText;
    }
</script>
